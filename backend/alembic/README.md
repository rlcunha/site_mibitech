# Sistema de Migrações de Banco de Dados

Este diretório contém o sistema de migrações de banco de dados usando Alembic.

## Visão Geral

O sistema de migrações permite:

- Controlar versões do esquema de banco de dados
- Aplicar alterações de forma consistente
- Reverter mudanças quando necessário
- Gerar migrações automaticamente a partir de modelos

## Estrutura

- `alembic.ini` - Arquivo de configuração principal
- `env.py` - Ambiente de execução do Alembic
- `script.py.mako` - Template para arquivos de migração
- `versions/` - Diretório com arquivos de migração

## Comandos Básicos

### Criar uma Nova Migração

Para criar uma migração manualmente:

```bash
alembic revision -m "descrição da migração"
```

Para gerar automaticamente com base nas alterações dos modelos:

```bash
alembic revision --autogenerate -m "descrição da migração"
```

### Aplicar Migrações

Para aplicar todas as migrações pendentes:

```bash
alembic upgrade head
```

Para aplicar um número específico de migrações:

```bash
alembic upgrade +2  # Aplica as próximas 2 migrações
```

### Reverter Migrações

Para reverter a última migração:

```bash
alembic downgrade -1
```

Para reverter todas as migrações:

```bash
alembic downgrade base
```

### Verificar Status

Para ver o status atual das migrações:

```bash
alembic current
```

Para ver o histórico de migrações:

```bash
alembic history
```

## Criando Migrações

### Migração Automática

O método recomendado é usar a geração automática:

1. Modifique os modelos SQLAlchemy em `app/models/`
2. Execute `alembic revision --autogenerate -m "descrição das alterações"`
3. Verifique o arquivo gerado em `versions/` e faça ajustes se necessário
4. Aplique a migração com `alembic upgrade head`

### Migração Manual

Para casos mais complexos, crie uma migração manual:

1. Execute `alembic revision -m "descrição da migração"`
2. Edite o arquivo gerado em `versions/` implementando as funções `upgrade()` e `downgrade()`
3. Aplique a migração com `alembic upgrade head`

## Exemplo de Migração

```python
"""criar tabela de usuários

Revision ID: a1b2c3d4e5f6
Revises: 
Create Date: 2025-04-05 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'a1b2c3d4e5f6'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # Criar tabela
    op.create_table(
        'usuarios',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('nome', sa.String(100), nullable=False),
        sa.Column('email', sa.String(255), nullable=False),
        sa.Column('senha_hash', sa.String(255), nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.func.now(), 
                 onupdate=sa.func.now()),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('email')
    )
    
    # Criar índice
    op.create_index('ix_usuarios_email', 'usuarios', ['email'], unique=True)

def downgrade():
    # Remover índice
    op.drop_index('ix_usuarios_email', 'usuarios')
    
    # Remover tabela
    op.drop_table('usuarios')
```

## Operações Comuns

### Adicionar Coluna

```python
op.add_column('tabela', sa.Column('nova_coluna', sa.String(50)))
```

### Remover Coluna

```python
op.drop_column('tabela', 'coluna_antiga')
```

### Alterar Coluna

```python
op.alter_column('tabela', 'coluna', 
                type_=sa.String(100),  # Novo tipo
                nullable=False)        # Nova restrição
```

### Criar Índice

```python
op.create_index('ix_tabela_coluna', 'tabela', ['coluna'], unique=True)
```

### Adicionar Chave Estrangeira

```python
op.create_foreign_key(
    'fk_posts_usuarios',  # Nome da constraint
    'posts',              # Tabela fonte
    'usuarios',           # Tabela alvo
    ['usuario_id'],       # Coluna(s) fonte
    ['id']                # Coluna(s) alvo
)
```

## Boas Práticas

1. **Sempre revise migrações autogenerated**: O Alembic pode não detectar todas as alterações corretamente

2. **Teste migrações antes de aplicar em produção**: Use um banco de dados de teste

3. **Inclua dados iniciais em migrações quando apropriado**: Use `op.bulk_insert()` para seed data

4. **Mantenha migrações idempotentes**: Verifique se objetos existem antes de criá-los

5. **Documente alterações complexas**: Adicione comentários explicando a lógica

6. **Planeje downgrades cuidadosamente**: Certifique-se de que as operações de reversão são completas

7. **Use branches para alterações paralelas**: Quando múltiplos desenvolvedores trabalham em alterações de esquema

## Solução de Problemas

### Conflitos de Migração

Se ocorrerem conflitos entre migrações:

1. Identifique as migrações conflitantes
2. Ajuste manualmente as dependências (`down_revision`)
3. Modifique as operações para evitar conflitos

### Erros de Migração

Se uma migração falhar:

1. Reverta para a versão anterior: `alembic downgrade -1`
2. Corrija o arquivo de migração
3. Tente novamente: `alembic upgrade head`

### Migrações Fora de Sincronia

Se o banco de dados e as migrações estiverem fora de sincronia:

1. Verifique o estado atual: `alembic current`
2. Marque manualmente a versão correta: `alembic stamp <revision>`